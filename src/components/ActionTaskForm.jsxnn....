import React, { useState, useEffect } from "react";
import api from "../api/api";

// Base rates per action
const ACTIONS = {
  like: 5,
  share: 10,
  comment: 15,
  follow: 20,
};

// Allowed quantities
const QUANTITY_OPTIONS = [10, 20, 50, 100, 200, 500, 600, 700, 800, 900, 1000];

export default function ActionTaskForm({ action = "like" }) {
  const [selectedAction, setSelectedAction] = useState(action);
  const [quantity, setQuantity] = useState(10);
  const [url, setUrl] = useState("");
  const [msg, setMsg] = useState("");
  const [userPoints, setUserPoints] = useState(0);
  const [totalPoints, setTotalPoints] = useState(ACTIONS[action] * 10);

  // Load user points balance
  useEffect(() => {
    (async () => {
      try {
        const res = await api.get("/users/me");
        setUserPoints(res.data.points || 0);
      } catch (err) {
        console.error(err);
      }
    })();
  }, []);

  // Calculate total points whenever action or quantity changes
  useEffect(() => {
    const baseRate = ACTIONS[selectedAction] || 5;
    setTotalPoints(baseRate * quantity);
  }, [selectedAction, quantity]);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!url) return alert("Please paste a valid URL");

    try {
      await api.post("/tasks/action", {
        url,
        action: selectedAction,
        quantity,
        points: totalPoints,
      });
      setMsg(`‚úÖ ${selectedAction} task submitted!`);
      setUrl("");
    } catch (err) {
      console.error(err);
      setMsg("‚ùå Submission failed.");
    }
  };

  return (
    <div className="max-w-xl mx-auto mt-6 p-6 bg-white rounded shadow space-y-4">
      <div className="text-center text-lg font-bold text-purple-700">
        üéØ Your Points Balance: {userPoints}
      </div>

      <h2 className="text-xl font-bold capitalize">
        Submit {selectedAction} Task
      </h2>
      {msg && <p className="text-green-600">{msg}</p>}

      <form onSubmit={handleSubmit} className="space-y-3">
        {/* URL Input */}
        <input
          type="url"
          placeholder={`Paste ${selectedAction} target URL`}
          value={url}
          onChange={(e) => setUrl(e.target.value)}
          className="w-full p-2 border rounded"
          required
        />

        {/* Action Selector */}
        <select
          value={selectedAction}
          onChange={(e) => setSelectedAction(e.target.value)}
          className="w-full p-2 border rounded"
        >
          {Object.keys(ACTIONS).map((a) => (
            <option key={a} value={a}>
              {a.charAt(0).toUpperCase() + a.slice(1)}
            </option>
          ))}
        </select>

        {/* Quantity Selector */}
        <select
          value={quantity}
          onChange={(e) => setQuantity(parseInt(e.target.value))}
          className="w-full p-2 border rounded"
        >
          {QUANTITY_OPTIONS.map((q) => (
            <option key={q} value={q}>
              {q} {selectedAction}s
            </option>
          ))}
        </select>

        {/* Display total points required */}
        <p className="font-bold text-blue-700">
          Total Points Required: {totalPoints}
        </p>

        <button
          type="submit"
          className="w-full p-2 rounded text-white bg-green-600 hover:bg-green-700"
        >
          Submit {selectedAction} Promotion
        </button>
      </form>
    </div>
  );
}